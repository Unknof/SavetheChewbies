<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Donate • Save The Chewbies</title>
    <meta name="description" content="Donate to Save the Children via Tiltify and support the Baby Chew fundraiser." />

    <meta property="og:title" content="Donate • Save The Chewbies" />
    <meta property="og:description" content="Donate to Save the Children via Tiltify and support the Baby Chew fundraiser." />
    <meta property="og:image" content="./assets/icon.png" />
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="Donate • Save The Chewbies" />
    <meta name="twitter:description" content="Donate to Save the Children via Tiltify and support the Baby Chew fundraiser." />
    <meta name="twitter:image" content="./assets/icon.png" />

    <link rel="icon" href="./assets/icon.png" type="image/png" />
    <link rel="apple-touch-icon" href="./assets/icon.png" />

    <link rel="stylesheet" href="./assets/styles.css" />
  </head>
  <body>
    <a class="skip-link" href="#main">Skip to content</a>

    <header class="site-header">
      <div class="container header-inner">
        <div class="brand">
          <div class="brand-mark" aria-hidden="true"><img src="./assets/icon.png" alt="" width="42" height="42" /></div>
          <div class="brand-text">
            <div class="brand-name">Save The Chewbies</div>
            <div class="brand-tagline">Donate to Save the Children</div>
          </div>
        </div>

        <nav class="nav" aria-label="Primary">
          <a class="nav-link" href="./index.html">Home</a>
          <a class="nav-link nav-cta" href="./donate.html" aria-current="page">Donate</a>
          <a class="nav-link" href="./privacy.html">Privacy</a>
          <a class="nav-link" href="./privacy.html#contact">Contact</a>
        </nav>
      </div>
    </header>

    <main id="main" class="container">
      <section class="page-header">
        <h1>Donate</h1>
        <p class="lead">
          Help Save the Children and unlock in-game rewards!
        </p>
      </section>

      <section class="card">
        <h2>Donate to Save the Children</h2>
        <p>
          Donations go directly through Tiltify's secure platform. Your contribution helps Save the Children and unlocks milestones below.
        </p>
        <div class="actions">
          <a class="button" href="https://tiltify.com/@savethecewbies/savethechewbies-a-fundraiser-for-save-the-children" target="_blank" rel="noopener noreferrer">Donate on Tiltify</a>
        </div>
        <p class="note">
          This site does not handle payment information. Donations are processed securely by Tiltify.
        </p>
      </section>

      <section class="card">
        <h2 id="incentives">Incentives (milestones)</h2>
        <p>
          To give donors extra motivation, we’re building five incentives tied to the Baby Chew in-game pet.
          Once the incentive list is finalized on Tiltify, it will be mirrored here.
        </p>
        <p class="note" id="milestone-status">Milestones unlock in order. Loading current total…</p>
        <ul class="list" id="milestone-list">
          <li data-threshold="351" data-index="1"><strong>€351 — Tantrum (knockback reaction):</strong> When Baby Chew gets knocked back, the baby chewbies throw a little tantrum (harmless / cosmetic).</li>
          <li data-threshold="702" data-index="2"><strong>€702 — Playful sparring:</strong> Baby chewbies can have tiny harmless fights with other players’ baby chewbies.</li>
          <li data-threshold="702" data-index="3"><strong>€702 — Ice caves (build process):</strong> Baby Chew occasionally builds ice caves with a fun build animation.</li>
          <li data-threshold="1053" data-index="4"><strong>€1053 — Nydus teleport (fashionable):</strong> Baby Chew and the baby chewbies teleport to the current hero using the Nydus.</li>
          <li data-threshold="1404" data-index="5"><strong>€1404 — Mecha Baby Chew (skin):</strong> A Mecha Baby Chew skin (like Mecha Chew, but for Baby Chew).</li>
        </ul>
        <p class="note">
          We show the next milestone as soon as the previous one is met. The final milestone is always visible as a teaser.
        </p>
        <p class="note">
          I’ll be streaming the implementation of these features (Discord, and bilibili if possible). Exact stream times will be posted on the site.
        </p>
        <p class="note">
          Why €351? It comes from a Kerrigan Survival tournament on January 10–11 where players spawned a total of 351 baby chewbies.
        </p>
        <figure style="margin:14px 0 0;">
          <img
            src="./assets/chewbieCountProof/Game1.jpg"
            alt="Tournament proof screenshot: Game 1"
            style="max-width:100%;height:auto;border-radius:12px;display:block;"
            loading="lazy"
          />
          <figcaption class="note" style="margin-top:8px;">Proof screenshot (Game 1)</figcaption>
        </figure>

        <figure style="margin:14px 0 0;">
          <img
            src="./assets/chewbieCountProof/Game10.jpg"
            alt="Tournament proof screenshot: Game 10"
            style="max-width:100%;height:auto;border-radius:12px;display:block;"
            loading="lazy"
          />
          <figcaption class="note" style="margin-top:8px;">Proof screenshot (Game 10)</figcaption>
        </figure>
        <p class="note">
          Creator pledge (proof of concept): I'll personally donate €10 for every Baby Chew used in the tournament (6 total → €60) to help kick things off.
        </p>
      </section>

      <section class="card" id="privacy">
        <h2>Privacy & contact</h2>
        <p>
          See <a href="./privacy.html">Privacy</a> for data-retention notes and <a href="./privacy.html#contact">Contact</a>.
        </p>
      </section>

    </main>

    <footer class="site-footer">
      <div class="container footer-inner">
        <div>
          <div class="footer-title">Save The Chewbies</div>
          <div class="footer-sub">© <span id="year"></span></div>
        </div>
        <div class="footer-links">
          <a class="nav-link" href="./privacy.html">Privacy</a>
          <a class="nav-link" href="./privacy.html#contact">Contact</a>
          <a class="nav-link" href="./acknowledgements.html">Acknowledgements</a>
        </div>
      </div>
    </footer>

    <script>
      document.getElementById('year').textContent = new Date().getFullYear();

      (function () {
        const statusEl = document.getElementById('milestone-status');
        const listEl = document.getElementById('milestone-list');
        if (!statusEl || !listEl) return;

        function getItems() {
          return Array.from(listEl.querySelectorAll('li[data-threshold][data-index]'));
        }

        function fmtCurrency(value, currency) {
          try {
            return new Intl.NumberFormat('de-DE', {
              style: 'currency',
              currency: currency || 'EUR',
              maximumFractionDigits: 0,
            }).format(value);
          } catch {
            return String(Math.round(value));
          }
        }

        function applyVisibility(total, currency, goal) {
          const items = getItems();
          if (items.length === 0) return;

          const thresholds = items
            .map((li) => ({
              li,
              idx: Number(li.getAttribute('data-index')),
              t: Number(li.getAttribute('data-threshold')),
            }))
            .filter((x) => Number.isFinite(x.idx) && Number.isFinite(x.t))
            .sort((a, b) => a.idx - b.idx);

          // Determine highest unlocked by comparing totals to thresholds.
          let unlocked = 0;
          for (const m of thresholds) {
            if (total >= m.t) unlocked = Math.max(unlocked, m.idx);
          }

          const next = Math.min(unlocked + 1, thresholds.length);
          const last = thresholds.length;

          const nextMilestone = thresholds.find((m) => m.idx === next);
          const remaining = nextMilestone ? Math.max(0, nextMilestone.t - total) : 0;

          for (const m of thresholds) {
            const shouldShow = (m.idx <= unlocked) || (m.idx === next) || (m.idx === last);
            m.li.style.display = shouldShow ? '' : 'none';
            m.li.classList.toggle('milestone-locked', m.idx > unlocked);
            m.li.classList.toggle('milestone-unlocked', m.idx <= unlocked);
          }

          const hasGoal = typeof goal === 'number' && Number.isFinite(goal) && goal > 0;
          const raisedText = hasGoal
            ? `Raised: ${fmtCurrency(Math.floor(total), currency)} of ${fmtCurrency(Math.floor(goal), currency)}`
            : `Current total: ${fmtCurrency(Math.floor(total), currency)}`;

          if (unlocked >= last) {
            statusEl.textContent = `All milestones unlocked! ${raisedText}`;
          } else {
            statusEl.textContent = `${raisedText} • ${fmtCurrency(Math.ceil(remaining), currency)} to next milestone`;
          }
        }

        function showAll() {
          const items = getItems();
          for (const li of items) {
            li.style.display = '';
            li.classList.remove('milestone-locked');
            li.classList.remove('milestone-unlocked');
          }
        }

        async function loadMilestonesFromTiltify() {
          try {
            const r = await fetch('./incentives.php', { cache: 'no-store' });
            const data = await r.json();
            if (!data || data.ok !== true || !Array.isArray(data.milestones) || data.milestones.length === 0) {
              return;
            }

            const currency = typeof data.currency === 'string' ? data.currency : 'EUR';
            const milestones = data.milestones
              .map((m) => ({
                name: typeof m.name === 'string' ? m.name : '',
                description: typeof m.description === 'string' ? m.description : '',
                amount: typeof m.amount === 'number' ? m.amount : Number(m.amount),
              }))
              .filter((m) => m.name && Number.isFinite(m.amount));

            if (milestones.length === 0) return;

            listEl.innerHTML = '';
            milestones.forEach((m, i) => {
              const li = document.createElement('li');
              li.setAttribute('data-threshold', String(m.amount));
              li.setAttribute('data-index', String(i + 1));

              const strong = document.createElement('strong');
              strong.textContent = `${fmtCurrency(m.amount, currency)} — ${m.name}: `;
              li.appendChild(strong);

              li.appendChild(document.createTextNode(m.description || ''));
              listEl.appendChild(li);
            });
          } catch {
            // Non-fatal; page has a fallback list.
          }
        }

        async function refresh() {
          try {
            const r = await fetch('./milestones.php', { cache: 'no-store' });
            const data = await r.json();
            if (!data || data.ok !== true || typeof data.total !== 'number') {
              statusEl.textContent = 'Milestone total unavailable right now. Showing full list.';
              showAll();
              return;
            }
            applyVisibility(
              data.total,
              typeof data.currency === 'string' ? data.currency : 'EUR',
              typeof data.goal === 'number' ? data.goal : NaN
            );
          } catch {
            statusEl.textContent = 'Milestone total unavailable right now. Showing full list.';
            showAll();
          }
        }

        // Load milestone definitions once; then start total refresh loop.
        loadMilestonesFromTiltify().finally(() => {
          refresh();
          setInterval(refresh, 30000);
        });
      })();
    </script>
  </body>
</html>
