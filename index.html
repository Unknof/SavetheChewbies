<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Save The Chewbies</title>
    <meta name="description" content="Donate to Save the Children via Tiltify, with donation incentives that update live." />

    <meta property="og:title" content="Save The Chewbies" />
    <meta property="og:description" content="Donate to Save the Children via Tiltify, with donation incentives that update live." />
    <meta property="og:image" content="./assets/icon.png" />
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="Save The Chewbies" />
    <meta name="twitter:description" content="Donate to Save the Children via Tiltify, with donation incentives that update live." />
    <meta name="twitter:image" content="./assets/icon.png" />

    <link rel="icon" href="./assets/icon.png" type="image/png" />
    <link rel="apple-touch-icon" href="./assets/icon.png" />

    <link rel="stylesheet" href="./assets/styles.css" />
  </head>
  <body>
    <a class="skip-link" href="#main">Skip to content</a>

    <header class="site-header">
      <div class="container header-inner">
        <div class="brand">
          <div class="brand-mark" aria-hidden="true"><img src="./assets/icon.png" alt="" width="42" height="42" /></div>
          <div class="brand-text">
            <div class="brand-name">Save The Chewbies</div>
            <div class="brand-tagline">Donate to Save the Children</div>
          </div>
        </div>

        <nav class="nav" aria-label="Primary">
          <a class="nav-link" href="./index.html" aria-current="page">Home</a>
          <a class="nav-link nav-cta" href="./donate.html">Donate</a>
          <a class="nav-link" href="./privacy.html">Privacy</a>
          <a class="nav-link" href="./privacy.html#contact">Contact</a>
        </nav>
      </div>
    </header>

    <main id="main" class="container">
      <section class="hero">
        <div class="hero-copy">
          <h1>Make your donation count.</h1>
          <p class="lead">
            This site is a simple hub to help you donate to <strong>Save the Children</strong> through <strong>Tiltify</strong>.
          </p>
          <div class="actions">
            <a class="button" href="./donate.html">Donate now</a>
            <a class="button button-secondary" href="./donate.html#incentives">See milestones</a>
          </div>
        </div>

        <div class="hero-media" aria-label="How it works">
          <h2 style="margin:0 0 10px;font-size:1.1rem;">How it works</h2>
          <ol class="list" style="margin:0;padding-left:18px;">
            <li>Click <strong>Donate now</strong>.</li>
            <li>Donate on Tiltify to <strong>Save the Children</strong>.</li>
            <li>Track progress on the milestones below.</li>
          </ol>
          <p class="note" style="margin:10px 0 0;">
            This site does not handle payment information.
          </p>
        </div>
      </section>

      <section class="grid">
        <article class="card">
          <h2>Live total</h2>
          <div class="big-stat" id="stc-total">—</div>
          <p class="note" id="stc-next">Loading next milestone…</p>
          <div class="actions">
            <a class="button" href="./donate.html">Donate</a>
            <a class="button button-secondary" href="./donate.html#incentives">See milestones</a>
          </div>
        </article>

        <article class="card">
          <h2>Save the Children</h2>
          <p>
            A well-known charity with a long track record. This drive is focused on Save the Children.
          </p>
          <a class="text-link" href="./donate.html">Donate via Tiltify →</a>
        </article>

        <article class="card">
          <h2>Milestones & Incentives</h2>
          <p>
            Track donation milestones to unlock special Baby Chew features and cosmetics in-game.
          </p>
          <a class="text-link" href="./donate.html#incentives">View milestones →</a>
        </article>

        <article class="card">
          <h2>Incentives</h2>
          <p>
            We’re building five donation incentives tied to the Baby Chew in-game pet.
            They’ll be shown on Tiltify and mirrored here.
          </p>
          <a class="text-link" href="./donate.html#incentives">See milestones →</a>
          <p class="note">
            I’ll also stream the implementation (Discord, and bilibili if possible). Stream times will be posted here.
          </p>
        </article>

        <article class="card">
          <h2>Why €351?</h2>
          <p>
            The incentive amounts are based on a Kerrigan Survival tournament on January 10–11,
            where players spawned a total of 351 baby chewbies.
          </p>
          <figure style="margin:14px 0 0;">
            <img
              src="./assets/chewbieCountProof/Game1.jpg"
              alt="Tournament proof screenshot: Game 1"
              style="max-width:100%;height:auto;border-radius:12px;display:block;"
              loading="lazy"
            />
            <figcaption class="note" style="margin-top:8px;">Proof screenshot (Game 1)</figcaption>
          </figure>

          <figure style="margin:14px 0 0;">
            <img
              src="./assets/chewbieCountProof/Game10.jpg"
              alt="Tournament proof screenshot: Game 10"
              style="max-width:100%;height:auto;border-radius:12px;display:block;"
              loading="lazy"
            />
            <figcaption class="note" style="margin-top:8px;">Proof screenshot (Game 10)</figcaption>
          </figure>
        </article>

        <article class="card">
          <h2>Recent Donations</h2>
          <div id="donations-list">
            <p class="note">Loading donations...</p>
          </div>
        </article>
      </section>
    </main>

    <footer class="site-footer">
      <div class="container footer-inner">
        <div>
          <div class="footer-title">Save The Chewbies</div>
          <div class="footer-sub">© <span id="year"></span></div>
        </div>
        <div class="footer-links">
          <a class="nav-link" href="./privacy.html">Privacy</a>
          <a class="nav-link" href="./privacy.html#contact">Contact</a>
          <a class="nav-link" href="./acknowledgements.html">Acknowledgements</a>
        </div>
      </div>
    </footer>

    <script>
      document.getElementById('year').textContent = new Date().getFullYear();

      (function () {
        const totalEl = document.getElementById('stc-total');
        const nextEl = document.getElementById('stc-next');
        if (!totalEl || !nextEl) return;

        let milestones = [
          { idx: 1, t: 351, name: 'Tantrum' },
          { idx: 2, t: 702, name: 'Playful sparring' },
          { idx: 3, t: 702, name: 'Ice caves' },
          { idx: 4, t: 1053, name: 'Nydus teleport' },
          { idx: 5, t: 1404, name: 'Mecha Baby Chew' },
        ];

        function fmtCurrency(value, currency) {
          try {
            return new Intl.NumberFormat('de-DE', {
              style: 'currency',
              currency: currency || 'EUR',
              maximumFractionDigits: 0,
            }).format(value);
          } catch {
            return String(Math.round(value));
          }
        }

        function render(total, currency, goal) {
          if (typeof goal === 'number' && Number.isFinite(goal) && goal > 0) {
            totalEl.textContent = `${fmtCurrency(Math.floor(total), currency)} raised of ${fmtCurrency(Math.floor(goal), currency)}`;
          } else {
            totalEl.textContent = `${fmtCurrency(Math.floor(total), currency)} raised`;
          }

          const next = milestones.find((m) => total < m.t);
          if (!next) {
            nextEl.textContent = 'All milestones unlocked. Thank you!';
            return;
          }

          const remaining = Math.max(0, next.t - total);
          nextEl.textContent = `${fmtCurrency(Math.ceil(remaining), currency)} to next milestone: ${fmtCurrency(next.t, currency)} — ${next.name}`;
        }

        async function loadMilestonesFromTiltify() {
          try {
            const r = await fetch('./incentives.php', { cache: 'no-store' });
            const data = await r.json();
            if (!data || data.ok !== true || !Array.isArray(data.milestones) || data.milestones.length === 0) {
              return;
            }

            const ms = data.milestones
              .map((m, i) => ({
                idx: i + 1,
                t: typeof m.amount === 'number' ? m.amount : Number(m.amount),
                name: typeof m.name === 'string' ? m.name : '',
              }))
              .filter((m) => Number.isFinite(m.t) && m.name);

            if (ms.length > 0) {
              milestones = ms;
            }
          } catch {
            // Non-fatal.
          }
        }

        async function refresh() {
          try {
            const r = await fetch('./milestones.php', { cache: 'no-store' });
            const data = await r.json();
            if (!data || data.ok !== true || typeof data.total !== 'number') {
              totalEl.textContent = 'Total unavailable';
              nextEl.textContent = 'Set tiltify_campaign_id (or milestone_total_override) to enable live totals.';
              return;
            }
            render(
              data.total,
              typeof data.currency === 'string' ? data.currency : 'EUR',
              typeof data.goal === 'number' ? data.goal : NaN
            );
          } catch {
            totalEl.textContent = 'Total unavailable';
            nextEl.textContent = 'Could not load current total.';
          }
        }

        loadMilestonesFromTiltify().finally(() => {
          refresh();
          setInterval(refresh, 30000);
        });
      })();

      // Recent donations display
      (function () {
        const donationsEl = document.getElementById('donations-list');
        if (!donationsEl) return;

        function fmtCurrency(value, currency) {
          try {
            return new Intl.NumberFormat('en-US', {
              style: 'currency',
              currency: currency || 'USD',
              maximumFractionDigits: 0,
            }).format(value);
          } catch {
            return '$' + String(Math.round(value));
          }
        }

        function formatTime(isoString) {
          try {
            const date = new Date(isoString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
          } catch {
            return '';
          }
        }

        async function loadDonations() {
          try {
            const r = await fetch('./donations.php', { cache: 'no-store' });
            const data = await r.json();
            
            if (!data || data.ok !== true || !Array.isArray(data.donations)) {
              donationsEl.innerHTML = '<p class="note">No donations yet.</p>';
              return;
            }

            if (data.donations.length === 0) {
              donationsEl.innerHTML = '<p class="note">No donations yet. Be the first!</p>';
              return;
            }

            // Show up to 10 most recent
            const recent = data.donations.slice(0, 10);
            
            const html = recent.map(d => {
              const name = d.donor_name || 'Anonymous';
              const amount = fmtCurrency(d.amount, d.currency);
              const time = formatTime(d.completed_at);
              const message = d.donor_message && d.donor_message.trim() !== '' 
                ? `<div class="note" style="margin-top:4px;font-style:italic;">"${escapeHtml(d.donor_message)}"</div>`
                : '';
              
              return `
                <div style="padding:12px 0;border-bottom:1px solid rgba(255,255,255,0.1);">
                  <div style="display:flex;justify-content:space-between;align-items:baseline;">
                    <strong>${escapeHtml(name)}</strong>
                    <span style="color:rgba(255,255,255,0.7);font-size:0.9em;">${amount}</span>
                  </div>
                  ${message}
                  ${time ? `<div class="note" style="margin-top:4px;font-size:0.85em;">${time}</div>` : ''}
                </div>
              `;
            }).join('');

            donationsEl.innerHTML = html || '<p class="note">No donations to display.</p>';
          } catch (e) {
            donationsEl.innerHTML = '<p class="note">Could not load donations.</p>';
          }
        }

        function escapeHtml(text) {
          const div = document.createElement('div');
          div.textContent = text;
          return div.innerHTML;
        }

        loadDonations();
        setInterval(loadDonations, 30000); // Refresh every 30 seconds
      })();
    </script>
  </body>
</html>
