<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Save The Chewbies</title>
    <meta name="description" content="Donate to Save the Children via Tiltify, with donation incentives that update live." />

    <link rel="stylesheet" href="./assets/styles.css" />
  </head>
  <body>
    <a class="skip-link" href="#main">Skip to content</a>

    <header class="site-header">
      <div class="container header-inner">
        <div class="brand">
          <div class="brand-mark" aria-hidden="true">STC</div>
          <div class="brand-text">
            <div class="brand-name">Save The Chewbies</div>
            <div class="brand-tagline">Donate to Save the Children (with fun incentives)</div>
          </div>
        </div>

        <nav class="nav" aria-label="Primary">
          <a class="nav-link" href="./index.html" aria-current="page">Home</a>
          <a class="nav-link nav-cta" href="./donate.html">Donate</a>
          <a class="nav-link" href="./privacy.html">Privacy</a>
          <a class="nav-link" href="./privacy.html#contact">Contact</a>
        </nav>
      </div>
    </header>

    <main id="main" class="container">
      <section class="hero">
        <div class="hero-copy">
          <h1>Make your donation count.</h1>
          <p class="lead">
            This site is a simple hub to help you donate to <strong>Save the Children</strong>.
            Donations run through <strong>Tiltify</strong>, so we can verify them via webhook events instead of relying on screenshots.
          </p>
          <div class="actions">
            <a class="button" href="./donate.html">Donate now</a>
            <a class="button button-secondary" href="./donate.html#incentives">See milestones</a>
            <a class="button button-secondary" href="./verify.php">Verify a code</a>
          </div>
        </div>

        <div class="hero-media" aria-label="How it works">
          <h2 style="margin:0 0 10px;font-size:1.1rem;">How it works</h2>
          <ol class="list" style="margin:0;padding-left:18px;">
            <li>Click <strong>Start verified donation</strong>.</li>
            <li>Donate on Tiltify to <strong>Save the Children</strong>.</li>
            <li>Return here to check your <strong>verification code</strong>.</li>
          </ol>
          <p class="note" style="margin:10px 0 0;">
            This site does not handle payment information.
          </p>
        </div>
      </section>

      <section class="grid">
        <article class="card">
          <h2>Live total</h2>
          <div class="big-stat" id="stc-total">—</div>
          <p class="note" id="stc-next">Loading next milestone…</p>
          <div class="actions">
            <a class="button" href="./donate.html">Donate</a>
            <a class="button button-secondary" href="./donate.html#incentives">See milestones</a>
          </div>
        </article>

        <article class="card">
          <h2>Save the Children</h2>
          <p>
            A well-known charity with a long track record. This drive is focused on Save the Children.
          </p>
          <a class="text-link" href="./donate.html">Donate via Tiltify →</a>
        </article>

        <article class="card">
          <h2>Donation verification</h2>
          <p>
            Start a verified donation, get a code, and this site verifies it via signed webhook events.
            No screenshots.
          </p>
          <a class="text-link" href="./verify.php">Verify a code →</a>
          <a class="text-link" href="./donate.html#verification">How it works →</a>
        </article>

        <article class="card">
          <h2>Incentives</h2>
          <p>
            We’re building five donation incentives tied to the Baby Chew in-game pet.
            They’ll be shown on Tiltify and mirrored here.
          </p>
          <a class="text-link" href="./donate.html#incentives">See milestones →</a>
          <p class="note">
            I’ll also stream the implementation (Discord, and bilibili if possible). Stream times will be posted here.
          </p>
        </article>

        <article class="card">
          <h2>Why €351?</h2>
          <p>
            The incentive amounts are based on a Kerrigan Survival tournament on January 10–11,
            where players spawned a total of 351 baby chewbies.
          </p>
          <figure style="margin:14px 0 0;">
            <img
              src="./assets/chewbieCountProof/Game1.jpg"
              alt="Tournament proof screenshot: Game 1"
              style="max-width:100%;height:auto;border-radius:12px;display:block;"
              loading="lazy"
            />
            <figcaption class="note" style="margin-top:8px;">Proof screenshot (Game 1)</figcaption>
          </figure>

          <figure style="margin:14px 0 0;">
            <img
              src="./assets/chewbieCountProof/Game10.jpg"
              alt="Tournament proof screenshot: Game 10"
              style="max-width:100%;height:auto;border-radius:12px;display:block;"
              loading="lazy"
            />
            <figcaption class="note" style="margin-top:8px;">Proof screenshot (Game 10)</figcaption>
          </figure>
        </article>
      </section>
    </main>

    <footer class="site-footer">
      <div class="container footer-inner">
        <div>
          <div class="footer-title">Save The Chewbies</div>
          <div class="footer-sub">© <span id="year"></span></div>
        </div>
        <div class="footer-links">
          <a class="nav-link" href="./privacy.html">Privacy</a>
          <a class="nav-link" href="./privacy.html#contact">Contact</a>
        </div>
      </div>
    </footer>

    <script>
      document.getElementById('year').textContent = new Date().getFullYear();

      (function () {
        const totalEl = document.getElementById('stc-total');
        const nextEl = document.getElementById('stc-next');
        if (!totalEl || !nextEl) return;

        let milestones = [
          { idx: 1, t: 351, name: 'Tantrum' },
          { idx: 2, t: 702, name: 'Playful sparring' },
          { idx: 3, t: 702, name: 'Ice caves' },
          { idx: 4, t: 1053, name: 'Nydus teleport' },
          { idx: 5, t: 1404, name: 'Mecha Baby Chew' },
        ];

        function fmtCurrency(value, currency) {
          try {
            return new Intl.NumberFormat('de-DE', {
              style: 'currency',
              currency: currency || 'EUR',
              maximumFractionDigits: 0,
            }).format(value);
          } catch {
            return String(Math.round(value));
          }
        }

        function render(total, currency) {
          totalEl.textContent = `${fmtCurrency(Math.floor(total), currency)} raised`;

          const next = milestones.find((m) => total < m.t);
          if (!next) {
            nextEl.textContent = 'All milestones unlocked. Thank you!';
            return;
          }

          const remaining = Math.max(0, next.t - total);
          nextEl.textContent = `${fmtCurrency(Math.ceil(remaining), currency)} to next milestone: ${fmtCurrency(next.t, currency)} — ${next.name}`;
        }

        async function loadMilestonesFromTiltify() {
          try {
            const r = await fetch('./incentives.php', { cache: 'no-store' });
            const data = await r.json();
            if (!data || data.ok !== true || !Array.isArray(data.milestones) || data.milestones.length === 0) {
              return;
            }

            const ms = data.milestones
              .map((m, i) => ({
                idx: i + 1,
                t: typeof m.amount === 'number' ? m.amount : Number(m.amount),
                name: typeof m.name === 'string' ? m.name : '',
              }))
              .filter((m) => Number.isFinite(m.t) && m.name);

            if (ms.length > 0) {
              milestones = ms;
            }
          } catch {
            // Non-fatal.
          }
        }

        async function refresh() {
          try {
            const r = await fetch('./milestones.php', { cache: 'no-store' });
            const data = await r.json();
            if (!data || data.ok !== true || typeof data.total !== 'number') {
              totalEl.textContent = 'Total unavailable';
              nextEl.textContent = 'Set tiltify_campaign_id (or milestone_total_override) to enable live totals.';
              return;
            }
            render(data.total, typeof data.currency === 'string' ? data.currency : 'EUR');
          } catch {
            totalEl.textContent = 'Total unavailable';
            nextEl.textContent = 'Could not load current total.';
          }
        }

        loadMilestonesFromTiltify().finally(() => {
          refresh();
          setInterval(refresh, 30000);
        });
      })();
    </script>
  </body>
</html>
